<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>solaire - simple example</title>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<script type="module">

			import { World, Direction } from '../dist/solaire.module.js';

			const world = World.create({

				seed: 'black sabbath iron maiden judas priest',

				bounds: {
                    x: { min: -6, max: 6, wrap: true },
					y: { min: -6, max: 6, wrap: true }
				},

				regionSize: 32,

				regions: {
					sparseCave: {
						init({ data }) {

							data.randomize([
								{ value: 0, weight: 101 },
								{ value: 1, weight: 99 }
							]);
						}
					},
					denseCave: {
						init({ data }) {

							data.randomize([
								{ value: 0, weight: 115 },
								{ value: 1, weight: 85 }
							]);
						}
					},
					goldDeposit: {
						init({ data }) {

							data.randomize([
								{ value: 0, weight: 5 },
								{ value: 1, weight: 5 },
								{ value: 3, weight: 6 }
							]);
						}
					}
				},

				chooseRegion() {

					return [
						{ value: 'sparseCave', weight: 15 },
						{ value: 'denseCave', weight: 14 },
						{ value: 'goldDeposit', weight: 1 }
					];
				},

				generate({ regions, effects }) {

					regions.select(['sparseCave', 'denseCave'])
						.applyTimes(6, () => {
							return effects.cellularAutomata({
								live: 1,
								dead: 0,
								born: 5,
								survive: 3
							});
						})
						.applyTimes(5, () => {
							return effects.cellularAutomata({
								live: 1,
								dead: 0,
								born: 5,
								survive: 5
							});
						});

					regions.select('goldDeposit')
						.applyTimes(10, () => {
							return effects.majorityRules();
						});

					regions.select('sparseCave')
						.apply(() => {
							return effects.floodFill({
								start: { x: 16, y: 16 },
								target: 1,
								replace: 2,
								spread: 1,
								decay: 0.75
							});
						});
				}
			});

			world.generate();

			const size = 256;
			const unit = size / world.regionSize;
			const canvas = document.getElementById('canvas');
			const ctx = canvas.getContext('2d');

			canvas.width = size * 3;
			canvas.height = size * 3;

			function render() {

				let colors = ['gray', 'silver', 'skyblue', 'gold'];
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				Object.values(Direction.NEIGHBORS).forEach(dir => {

					let x = world.position.x + dir.x;
					let y = world.position.y + dir.y;
					let region = world.region({ x, y });

					if (!region) {
						return;
					}

					let origin = {
						x: (dir.x + 1) * size,
						y: (dir.y + 1) * size
					};

					region.data.each((el, x, y) => {

						let pos = {
							x: origin.x + (x * unit),
							y: origin.y + (y * unit)
						};

						ctx.fillStyle = colors[ el ];
						ctx.fillRect(pos.x, pos.y, unit, unit);
                    });
				});
			}

			document.addEventListener('keypress', async event => {

				switch (event.key) {
					case 'w':
						await world.moveNorth();
						break;
					case 'a':
						await world.moveWest();
						break;
					case 's':
						await world.moveSouth();
						break;
					case 'd':
						await world.moveEast();
						break;
				}

				if ('wasd'.includes(event.key)) {
					world.generate();
					render();
				}
			});

			render();

		</script>
	</body>
</html>